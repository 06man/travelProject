<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>예약 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>

<!--임시 예약 관리 페이지 (유저)-->
<!--레이아웃이 정해지면 수정할 것-->
<div class="btn-group" role="group" aria-label="Basic radio toggle button group">
    <input type="radio" class="btn-check" name="btnradio" id="btnradio1" data-order="PENDING" autocomplete="off"
           checked>
    <label class="btn btn-outline-primary" for="btnradio1">Pending</label>

    <input type="radio" class="btn-check" name="btnradio" id="btnradio2" data-order="COMPLETED" autocomplete="off">
    <label class="btn btn-outline-primary" for="btnradio2">Completed</label>

    <input type="radio" class="btn-check" name="btnradio" id="btnradio3" data-order="CANCELLED" autocomplete="off">
    <label class="btn btn-outline-primary" for="btnradio3">Cancelled</label>
</div>

<ul class="reservationList"></ul>
<ul class="pagination reservationListPagination"></ul>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/script/reservation/reservation.js"></script>
<script th:inline="javascript">
    const reservationList = document.querySelector(".reservationList")
    const reservationListPagination = document.querySelector(".reservationListPagination")
    let reservationOrder = 'PENDING'

    function printReservation(reservationOrder, page) {
        getUserReservation({reservationOrder, page})
            .then(data => {
                    resetReservation()
                    printReservationList(data.dtoList)
                    printReservationListPagination(data)
                }
            ).catch(e => {
                console.error(e)
            }
        )
    }

    function resetReservation() {
        reservationList.innerHTML = ''
        reservationListPagination.innerHTML = ''
    }

    function printReservationList(dtoList) {
        let str = ""
        if (dtoList && dtoList.length > 0) {
            for (const dto of dtoList) {
                str += `
               <li class="list-group-item d-flex replyItem">
               <span class="col-1">${dto.productName}</span>
               <span class="col-4">${dto.productDescription}</span>
               <span class="col-2">${dto.productStartDate}~${dto.productEndDate}</span>
               <span class="col-1">${dto.productPrice}원</span>
               <span class="col-1">${dto.productLocationCountry}/${dto.productLocationCity}</span>
                ${reservationOrder !== 'COMPLETED' ? `<button type="button" class="btn btn-primary feePaymentBtn" data-reservationNo="${dto.reservationNo}">결제</button>` : ''}
                ${reservationOrder !== 'CANCELLED' ? `<button type="button" class="btn btn-danger reservationDelBtn" data-reservationNo="${dto.reservationNo}">취소</button>` : ''}
                `
            }
        }
        reservationList.innerHTML = str
    }

    function printReservationListPagination(data) {
        let pageStr = ''
        if (data.prev) {
            pageStr += `<li class="page-item"><a class="page-link"
            data-page="${data.start - 1}">이전</a></li>
             `
        }
        for (let i = data.start; i <= data.end; i++) {
            pageStr += `
            <li class="${data.page == i}?'page-item active':'page-item'">
                                    <a class="page-link"
                                       data-page="${i}">${i}</a>
                                </li>
            `
        }
        if (data.next) {
            pageStr += `<li class="page-item"><a class="page-link"
            data-page="${data.end + 1}">다음</a></li>
             `
        }
        reservationListPagination.innerHTML = pageStr
    }

    let page = 1
    reservationListPagination.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const target = e.target

        if (!target || target.tagName != 'A') {
            return
        }
        const pageNum = target.getAttribute("data-page")
        page = pageNum
        printReservation(reservationOrder, page)

    }, false)

    printReservation(reservationOrder, page)

    document.querySelector(".btn-group").addEventListener("click", function (e) {
        const target = e.target
        if (target.tagName != 'INPUT') return
        reservationOrder = target.getAttribute("data-order")
        printReservation(reservationOrder)
    }, false)

    document.querySelector(".reservationList").addEventListener("click", function (e) {
        const target = e.target
        if (!target.classList.contains('feePaymentBtn')) return
        const reservationNo = target.getAttribute("data-reservationNo")
        console.log("결제 클릭됨, reservationNo 는 " + reservationNo)
        feeReservation(reservationNo).then(data => {
                console.log(data)
                printReservation(reservationOrder, page)
            }
        ).catch(e => console.error(e))
    })
    document.querySelector(".reservationList").addEventListener("click", function (e) {
        const target = e.target
        if (!target.classList.contains('reservationDelBtn')) return
        const reservationNo = target.getAttribute("data-reservationNo")
        console.log("취소 클릭됨, reservationNo 는 " + reservationNo)
        deleteReservation(reservationNo).then(data =>
            printReservation(reservationOrder, page)
        ).catch(e => console.error(e))

    })
</script>
</body>
</html>